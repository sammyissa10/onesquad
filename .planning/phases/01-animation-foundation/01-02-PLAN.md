---
phase: 01-animation-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/lib/gsap.ts
  - src/lib/providers/SmoothScrollProvider.tsx
  - src/hooks/useScrollAnimation.ts
autonomous: false

must_haves:
  truths:
    - "Users who prefer reduced motion see no smooth scroll momentum — Lenis interpolation is disabled, page scrolls natively"
    - "Users who prefer reduced motion will not see GSAP-driven animations when future phases add them — the gsap.matchMedia pattern in useScrollAnimation branches on the media query"
    - "ScrollTrigger instances created inside useScrollAnimation clean up automatically when the component unmounts or the route changes — via useGSAP scope"
    - "A reusable useScrollAnimation hook exists that future phases import to create scroll-triggered animations with built-in reduced-motion branching and automatic cleanup"
    - "After navigating between multiple pages, no ghost ScrollTrigger instances persist"
  artifacts:
    - path: "src/hooks/useScrollAnimation.ts"
      provides: "Reusable scroll animation hook wrapping useGSAP with scope-based cleanup and gsap.matchMedia reduced-motion branching"
      exports: ["useScrollAnimation"]
    - path: "src/lib/gsap.ts"
      provides: "Updated centralized config with MOTION_QUERIES constant for media query reuse"
      exports: ["gsap", "ScrollTrigger", "MOTION_QUERIES"]
    - path: "src/lib/providers/SmoothScrollProvider.tsx"
      provides: "Updated provider that respects prefers-reduced-motion by disabling Lenis smooth interpolation"
      exports: ["SmoothScrollProvider"]
  key_links:
    - from: "src/hooks/useScrollAnimation.ts"
      to: "src/lib/gsap.ts"
      via: "import { gsap, ScrollTrigger, MOTION_QUERIES } from '@/lib/gsap'"
      pattern: "import.*from.*@/lib/gsap"
    - from: "src/hooks/useScrollAnimation.ts"
      to: "@gsap/react"
      via: "useGSAP hook with scope parameter for automatic ScrollTrigger cleanup on unmount"
      pattern: "useGSAP.*scope"
    - from: "src/hooks/useScrollAnimation.ts"
      to: "gsap.matchMedia"
      via: "matchMedia branching on prefers-reduced-motion inside useGSAP callback"
      pattern: "matchMedia.*prefers-reduced-motion|MOTION_QUERIES"
    - from: "src/lib/providers/SmoothScrollProvider.tsx"
      to: "prefers-reduced-motion"
      via: "window.matchMedia check controlling Lenis smooth scroll interpolation"
      pattern: "prefers-reduced-motion"
---

<objective>
Create the reduced-motion accessibility layer and reusable scroll animation hook with automatic useGSAP-scoped cleanup.

Purpose: ANIM-05 requires all animations to respect prefers-reduced-motion. ANIM-06 requires ScrollTrigger instances to clean up on route changes via useGSAP hook scoping. This plan creates the reusable patterns that all future phases (2-8) will use when adding scroll-triggered animations — without this, every component would need to manually handle cleanup and reduced-motion checks.

Output: A `useScrollAnimation` hook wrapping useGSAP with scope + matchMedia, updated SmoothScrollProvider with reduced-motion awareness, and MOTION_QUERIES constant in lib/gsap.ts.
</objective>

<execution_context>
@C:/Users/sammy/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/sammy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-animation-foundation/01-RESEARCH.md
@.planning/phases/01-animation-foundation/01-01-SUMMARY.md
@src/lib/gsap.ts
@src/lib/providers/SmoothScrollProvider.tsx
@src/app/layout.tsx
@src/app/globals.css
@src/components/ui/ScrollToTop.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add MOTION_QUERIES to gsap.ts and integrate reduced-motion into SmoothScrollProvider</name>
  <files>src/lib/gsap.ts, src/lib/providers/SmoothScrollProvider.tsx</files>
  <action>
1. Update `src/lib/gsap.ts` — add a reusable media query constant:
   ```typescript
   export const MOTION_QUERIES = {
     reduced: '(prefers-reduced-motion: reduce)',
     noPreference: '(prefers-reduced-motion: no-preference)',
   } as const;
   ```
   Export it alongside the existing `gsap` and `ScrollTrigger` exports. This prevents every component from hardcoding the media query string.

2. Update `src/lib/providers/SmoothScrollProvider.tsx` to respect prefers-reduced-motion:

   a. Add a reduced-motion detection state:
      - Use `useState<boolean>(false)` for `prefersReducedMotion` (default false = animations enabled, safe SSR default)
      - In a `useEffect`, read `window.matchMedia('(prefers-reduced-motion: reduce)').matches` to set initial state
      - Add a `change` event listener on the MediaQueryList to update state reactively (so toggling in OS settings mid-session works)
      - Clean up the event listener on unmount

   b. Adjust Lenis options based on reduced-motion state:
      - When `prefersReducedMotion === true`: set `lerp: 1` (instant — no interpolation), `smoothWheel: false`, `smoothTouch: false`
      - When `prefersReducedMotion === false`: keep existing config (`lerp: 0.075`, `smoothWheel: true`, `smoothTouch: true`, etc.)
      - Use `useMemo` to compute the options object, keyed on `prefersReducedMotion`

   c. Handle ReactLenis reactivity:
      - ReactLenis may not dynamically update when `options` prop changes after mount. To handle this, add a `key` prop to `<ReactLenis>` that changes when `prefersReducedMotion` changes (e.g., `key={prefersReducedMotion ? 'reduced' : 'full'}`). This forces a clean remount.
      - When ReactLenis remounts, the GSAP ticker effect also needs to reconnect. Ensure the ticker `useEffect` uses the lenisRef correctly after remount.

   d. Add route-change ScrollTrigger cleanup (safety net alongside useGSAP scoping):
      - In the existing `useEffect` keyed on `pathname`:
        - Before calling `ScrollTrigger.refresh()`, call `ScrollTrigger.getAll().forEach(st => st.kill())` to clear any triggers that useGSAP might have missed
        - This is a defense-in-depth measure — useGSAP scope handles per-component cleanup, this handles edge cases

   e. Add development-only debug logging:
      - In the pathname `useEffect`, when `process.env.NODE_ENV === 'development'`:
        ```
        console.debug(`[ScrollTrigger] Active instances after cleanup: ${ScrollTrigger.getAll().length}`);
        ```
      - This helps future phases verify that trigger count returns to 0 between routes

IMPORTANT: Do NOT remove Lenis entirely when reduced motion is active. Keep it mounted so that when Phase 8 adds ScrollTrigger animations, the scroll position sync still works. Only disable the smooth interpolation.

IMPORTANT: Do NOT modify ScrollToTop, ChatWidget, or ThemeProvider. Read the 01-01-SUMMARY.md first — if it notes ScrollToTop works with Lenis, leave it. If it notes issues, fix only the specific issue.
  </action>
  <verify>
- `npm run build` — builds successfully with no errors
- `src/lib/gsap.ts` exports `MOTION_QUERIES` with `reduced` and `noPreference` keys
- `src/lib/providers/SmoothScrollProvider.tsx` reads prefers-reduced-motion and adjusts Lenis config
- In Chrome DevTools > Rendering > toggle "Emulate CSS media feature prefers-reduced-motion: reduce":
  - ON: scroll feels native (instant, no momentum, no smooth interpolation)
  - OFF: smooth scroll resumes with momentum
- Toggle mid-session without reload — behavior switches reactively
  </verify>
  <done>MOTION_QUERIES constant exported from lib/gsap.ts. SmoothScrollProvider disables Lenis smooth interpolation when prefers-reduced-motion is active, keeps Lenis mounted for ScrollTrigger compatibility, and switches reactively without page reload. Route-change cleanup kills stale ScrollTrigger instances as a safety net.</done>
</task>

<task type="auto">
  <name>Task 2: Create useScrollAnimation hook with useGSAP scope and matchMedia branching</name>
  <files>src/hooks/useScrollAnimation.ts</files>
  <action>
1. Create directory `src/hooks/` if it does not exist.

2. Create `src/hooks/useScrollAnimation.ts` — the reusable hook for all future scroll-triggered animations:

   **Purpose:** Wraps `useGSAP` from `@gsap/react` with:
   - Automatic ScrollTrigger cleanup via `scope` parameter (ANIM-06 core mechanism)
   - Built-in prefers-reduced-motion branching via `gsap.matchMedia()` (ANIM-05)
   - Sensible defaults to eliminate boilerplate in future phases

   **Hook signature:**
   ```typescript
   interface UseScrollAnimationOptions {
     // Pass false to disable the hook entirely (for conditional usage)
     enabled?: boolean;
     // Dependencies array for useGSAP (triggers re-run when changed)
     deps?: unknown[];
   }

   type AnimationCallback = (context: {
     gsap: typeof gsap;
     ScrollTrigger: typeof ScrollTrigger;
   }) => void;

   export function useScrollAnimation(
     // Called only when prefers-reduced-motion is NOT active
     animate: AnimationCallback,
     options?: UseScrollAnimationOptions
   ): {
     scope: React.RefObject<HTMLDivElement | null>;
     contextSafe: <T extends (...args: unknown[]) => void>(fn: T) => T;
   }
   ```

   **Implementation:**
   a. Create a `useRef<HTMLDivElement>(null)` for `scope` — the container ref.

   b. Call `useGSAP(() => { ... }, { scope: scopeRef, dependencies: options?.deps ?? [] })`:
      - The `scope` parameter is the KEY to ANIM-06. It tells useGSAP to automatically revert all GSAP animations and kill all ScrollTrigger instances created inside the callback when the component unmounts or dependencies change. No manual cleanup needed.

   c. Inside the useGSAP callback:
      - If `options?.enabled === false`, return early (no-op).
      - Create a matchMedia instance: `const mm = gsap.matchMedia()`
      - Add the animation branch:
        ```
        mm.add(MOTION_QUERIES.noPreference, () => {
          animate({ gsap, ScrollTrigger });
        });
        ```
      - Add the reduced-motion branch:
        ```
        mm.add(MOTION_QUERIES.reduced, () => {
          // Make all potentially-animated elements visible
          // Future animations that start with opacity:0 or transforms
          // need their targets to be visible when animations are disabled
          gsap.set(scopeRef.current!.querySelectorAll('[data-animate]'), {
            opacity: 1,
            x: 0,
            y: 0,
            scale: 1,
            rotation: 0,
            clearProps: 'all',
          });
        });
        ```
      - Return cleanup: `() => mm.revert()` — useGSAP's context handles calling this.

   d. Store `contextSafe` from the useGSAP return value. This is needed for any GSAP animations triggered by user events (clicks, hovers) inside the scoped component.

   e. Return `{ scope, contextSafe }`.

   **Add JSDoc with usage example at top of file:**
   ```typescript
   /**
    * Reusable scroll animation hook with automatic cleanup and reduced-motion support.
    *
    * - Wraps useGSAP with `scope` for automatic ScrollTrigger cleanup on unmount (ANIM-06)
    * - Uses gsap.matchMedia to disable animations when prefers-reduced-motion is active (ANIM-05)
    * - Elements with `data-animate` attribute are made visible when animations are disabled
    *
    * @example
    * function MySection() {
    *   const { scope } = useScrollAnimation(({ gsap, ScrollTrigger }) => {
    *     gsap.from('.item', {
    *       opacity: 0, y: 50, stagger: 0.08,
    *       scrollTrigger: { trigger: '.items-container', start: 'top 80%' }
    *     });
    *   });
    *   return <section ref={scope}>...</section>;
    * }
    */
   ```

3. Export `useScrollAnimation` as a named export.

IMPORTANT: Import gsap, ScrollTrigger, and MOTION_QUERIES from `@/lib/gsap`, NOT from 'gsap' directly. Centralized plugin registration.

IMPORTANT: Import `useGSAP` from `@gsap/react`, NOT writing a custom useEffect-based cleanup. The useGSAP hook IS the ANIM-06 mechanism.

IMPORTANT: The `scope` ref must be attached to a container element (like `<section ref={scope}>`) by the consuming component. All GSAP selectors inside the callback (like `.item`) are automatically scoped to this container — GSAP will only find elements INSIDE the container, preventing cross-component selector leaks.
  </action>
  <verify>
- `npm run build` — no TypeScript errors
- `src/hooks/useScrollAnimation.ts` exists and exports `useScrollAnimation`
- Grep confirms: imports from `@/lib/gsap` (not from 'gsap' directly)
- Grep confirms: uses `useGSAP` with a `scope` parameter
- Grep confirms: uses `gsap.matchMedia()` with `MOTION_QUERIES`
- Grep confirms: returns `{ scope, contextSafe }`
- The hook does NOT create any visible animations — it's pure infrastructure for future phases
  </verify>
  <done>Reusable `useScrollAnimation` hook at `src/hooks/useScrollAnimation.ts`. Wraps useGSAP with automatic scope-based cleanup (ANIM-06) and gsap.matchMedia reduced-motion branching (ANIM-05). Exposes contextSafe for event-driven animations. Future phases import this hook to create scroll-triggered animations without manual cleanup or accessibility boilerplate.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete animation foundation</name>
  <what-built>Complete animation infrastructure: GSAP + Lenis smooth scroll with accessibility (prefers-reduced-motion) support, ScrollTrigger cleanup on route changes, and reusable useScrollAnimation hook for future phases.</what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Open http://localhost:3000 in browser

**Smooth scroll feel (from plan 01-01, confirming still works):**
3. Scroll with mouse wheel — should feel noticeably fluid, with momentum (like kota.co.uk / strangepixels.co)
4. Scroll with keyboard arrows, Space bar, Page Down — should scroll smoothly through Lenis
5. Navigate to a different page via nav links — page should scroll to top instantly (not gradually)
6. Click browser back button — previous page loads correctly

**Scrollbar hidden:**
7. Look at right edge of viewport — no scrollbar visible

**Accessibility / reduced motion (new in this plan):**
8. Open Chrome DevTools > three-dot menu > More tools > Rendering
9. Check "Emulate CSS media feature prefers-reduced-motion" and select "reduce"
10. Scroll with mouse wheel — should feel like NATIVE scroll now (instant, no momentum, no smooth interpolation)
11. Uncheck the emulation — smooth scroll should return immediately without page reload

**Existing functionality intact:**
12. Toggle dark/light theme — should still work
13. Scroll down past 500px — ScrollToTop button should appear and work when clicked
14. ChatWidget should remain functional

**No errors:**
15. Check browser console — no red errors related to GSAP, Lenis, hydration, or React
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` — zero errors
2. `npm run dev` — smooth scroll working on homepage
3. Mouse wheel scroll — fluid, momentum-based (not native)
4. Keyboard scroll — goes through Lenis
5. Route change — instant scroll to top, dev console shows `[ScrollTrigger] Active instances: 0`
6. Browser back — works correctly
7. Scrollbar — hidden
8. Reduced motion ON (DevTools) — native scroll, no momentum
9. Reduced motion OFF (DevTools) — smooth scroll returns immediately
10. Theme toggle — still works
11. ScrollToTop button — still appears and functions
12. ChatWidget — still functional
13. Console — no GSAP/Lenis/hydration errors
14. Navigate 5+ pages rapidly — no performance degradation or stuck elements
15. `src/hooks/useScrollAnimation.ts` — exports useScrollAnimation with useGSAP scope + matchMedia
</verification>

<success_criteria>
- ANIM-05 satisfied: prefers-reduced-motion disables Lenis smooth scroll AND provides matchMedia pattern (via useScrollAnimation) for all future GSAP animations
- ANIM-06 satisfied: useScrollAnimation hook uses useGSAP with scope for automatic ScrollTrigger cleanup on component unmount and route change
- Reusable hook pattern established at src/hooks/useScrollAnimation.ts — ready for Phase 2-8 to import
- MOTION_QUERIES constant exported from lib/gsap.ts for consistent media query usage
- Route-change cleanup kills stale ScrollTriggers as safety net
- Zero build errors, zero console errors
- All existing functionality intact (theme, ScrollToTop, ChatWidget, Framer Motion)
- Human verification confirms scroll feel and accessibility behavior
</success_criteria>

<output>
After completion, create `.planning/phases/01-animation-foundation/01-02-SUMMARY.md`
</output>
